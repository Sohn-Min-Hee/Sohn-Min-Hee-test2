<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ESP32 Potentiometer Test</title>
<style>
  body {margin:0; background:black; color:white;}
  video {width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0;}
  #pairBtn {
    position:fixed; top:10px; left:50%; transform:translateX(-50%);
    padding:10px 20px; font-size:18px; z-index:9999;
  }
  #gameUI {
    position:fixed; bottom:50px; left:50%; transform:translateX(-50%);
    width:80%; height:30px; background:#333; border-radius:15px;
    z-index:9999; overflow:hidden;
  }
  #gauge {height:100%; width:0%; background:lime;}
</style>
</head>
<body>

<button id="pairBtn">페어링</button>
<div id="gameUI"><div id="gauge"></div></div>

<video src="videoA.mp4" autoplay muted loop playsinline webkit-playsinline></video>

<script>
let characteristic;
let potValue = 0;
const gauge = document.getElementById("gauge");

// BLE 연결
async function connectBLE() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32-Pot" }],
      optionalServices: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"]
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService("4fafc201-1fb5-459e-8fcc-c5c9c331914b");
    characteristic = await service.getCharacteristic("beb5483e-36e1-4688-b7f5-ea07361b26a8");
    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged", handlePotValue);
    console.log("✅ BLE Connected!");
  } catch (err) {
    console.error("❌ BLE Error:", err);
  }
}

// 값 수신
function handlePotValue(event) {
  const dv = event.target.value;
  let v = 0;
  if (dv.byteLength >= 2) v = dv.getUint16(0, true);
  else v = dv.getUint8(0) * 16;
  potValue = Math.max(0, Math.min(4095, v));

  const percent = (potValue / 4095) * 100;
  gauge.style.width = percent + "%";
  console.log("Pot:", potValue, "->", percent+"%");
}

document.getElementById("pairBtn").addEventListener("click", connectBLE);
</script>
</body>
</html>